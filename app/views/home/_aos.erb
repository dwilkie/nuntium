<h4><%= link_to_function 'Last Application Originated Messages', "toggle('last_ao_messages')", :name => 'ao' %></h4>

<div id="last_ao_messages">
<form id="ao_messages_form" action="#ao">
<input type="hidden" name="ao_page" value="<%= @ao_page %>" />
<input type="hidden" name="ao_previous_search" value="<%= @ao_search %>" />
<input type="hidden" name="at_page" value="<%= @at_page %>" />
<input type="hidden" name="at_search" value="<%= @at_search %>" />
<input type="hidden" id="ao_all" name="ao_all" value="0" />

<% if @applications.empty? %>
  <%= link_to 'Create an Application', :controller => :home, :action => :new_application %> to create AO Messages.
<% else %>
  <%= link_to '<img src="/images/new_message.png" width="16" height="16" style="position:relative; top:4px" alt="Create new AO Message">Create new AO Message', :controller => :message, :action => :new_ao_message %> &nbsp; &nbsp;
<% end %>
Search: <input type="text" name="ao_search" value="<%= h @ao_search %>" size="50" /> <a href="http://code.google.com/p/nuntium/wiki/AdvancedSearch" target="_blank" title="You can filter by field like 'id:5', 'before:&quot;20 minutes ago&quot;', 'state:queued', etc.">?</a> &nbsp; &nbsp;
Select: <%= link_to_function 'all', 'select_all_ao_messages()' %>, <%= link_to_function 'none', 'select_none_ao_messages()' %> &nbsp; &nbsp;
Actions: <%= link_to_function 'mark as cancelled', 'mark_ao_messages_as_cancelled()' %>, <%= link_to_function 're-route', 'reroute_ao_messages()' %>

<div><%= page_entries_info @ao_messages, :entry_name => 'message' %></div>
<%= will_paginate @ao_messages, :param_name => 'ao_page', :params => { :ao_previous_search => @ao_search, :anchor => 'ao' } %>

<div id="all_ao_messages_text" style="display:none"></div>

<input type="hidden" name="ao_page" value="<%= @ao_page %>" />
<input type="hidden" name="ao_previous_search" value="<%= @ao_search %>" />
<input type="hidden" name="at_page" value="<%= @at_page %>" />
<input type="hidden" name="at_search" value="<%= @at_search %>" />
<input type="hidden" name="log_page" value="<%= @log_page %>" />
<input type="hidden" name="log_search" value="<%= @log_search %>" />

<% if !@ao_messages.empty? %>
  <table border="1" class="table">
    <tr>
      <th></th>
      <th>When</th>
      <th>Id</th>
      <th>Guid</th>
      <th>Channel Relative Id</th>
      <th>From</th>
      <th>To</th>
      <th>Subject</th>
      <th>Body</th>
      <th>Channel</th>
      <th>Application</th>
      <th>Tries</th>
      <th>State</th>
      <th></th>
    </tr>
    <tr>
    <% @ao_messages.each_with_index do |msg, i| %>
      <% 
      chan = @channels.select{|x| msg.channel_id == x.id}.first
      app = @applications.select{|x| msg.application_id == x.id}.first
      %>
      <tr class="<%= i.even_to_s %>">
        <td><input type="checkbox" name="ao_messages[]" value="<%= msg.id %>" <%= 'checked="checked"' if !params[:ao_messages].nil? && params[:ao_messages].include?(msg.id.to_s) %>/></td>
        <td>
          <% if msg.parent_id
            image_name = @ao_messages[i+1] && @ao_messages[i+1].parent_id == msg.parent_id ? 'branch' : 'branch_end'
            %>
            <%= image_tag "#{image_name}.png", :size => '16x16', :style => 'position:relative; top:4px' %>
          <% end %>
          <%= time_ago msg.timestamp %>
        </td>
        <td align="right"><%= msg.id %></td>
        <td><%= short_html msg.guid %></td>
        <td><%= short_html msg.channel_relative_id %></td>
        <td><%= msg.from %></td>
        <td><%= link_to msg.to, {:controller => :message, :action => :view_thread, :address => msg.to}, :target => '_blank' %></td>
        <td><%= short_html msg.subject %></td>
        <td><%= short_html msg.body %></td>
        <td><%= chan ? chan.name : '' %></td>
        <td><%= app ? app.name : '' %></td>
        <td align="right"><%= msg.tries %></td>
        <td><%= msg.state %></td>
        <td>
          <%= link_to 'view log', {:controller => :message, :action => :view_ao_message, :id => msg.id}, :target => '_blank'%>
        </td>
      </tr>
    <% end %>
  </table>
<% end %>

<%= will_paginate @ao_messages, :param_name => 'ao_page', :params => { :ao_previous_search => @ao_search, :anchor => 'ao' } %>
</form>
</div>
