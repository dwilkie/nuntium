<% if !flash[:notice].nil? %>
<div style="border:1px solid black; background:#FFF1A8; padding:4px; font-weight:bold"><%= flash[:notice] %></div>
<% end %>

<h4><a href="javascript:void(0)" onClick="toggle('interactions')">Interactions</a></h4>

<div id="interactions" style="display:none">
<% if @channels.empty? %>
  To interact with this application you must first create a new channel.
<% else %>
  <div style="padding-left:20px">
  
  <div><b>Via RSS</b></div>
  Use <a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">Http Basic Authentication</a> with application credentials.
  
  <ul>
    <li><span style="font-family:monospace">POST <%= url_for :controller => :rss, :action => :create %></span>: 
      create Application Originated Messages</li>
    <li><span style="font-family:monospace">GET <%= url_for :controller => :rss, :action => :index %></span>:
      read Application Terminated Messages</li>
  </ul>
  
  <% if !@channels.select {|c| c.kind == 'qst'}.empty? %>
    <div><b>Via <a href="http://code.google.com/p/geochat/wiki/QueueStateTransfer" target="_blank">QueueStateTransfer</a></b></div>
    Use <a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">Http Basic Authentication</a> with channel credentials.
    
    <ul>
      <li><span style="font-family:monospace">GET <%= url_for :controller => :outgoing, :action => :index, :application_id => @application.name %></span>:
        read Application Originated Messages</li>
      <li><span style="font-family:monospace">HEAD <%= url_for :controller => :incoming, :action => :index, :application_id => @application.name %></span>:
        get last Application Terminated Message id</li>
      <li><span style="font-family:monospace">POST <%= url_for :controller => :incoming, :action => :create, :application_id => @application.name %></span>:
        create Application Terminated Messages</li>
    </ul>
  <% end %>
  
  <% if !@channels.select {|c| c.kind == 'clickatell'}.empty? %>
    <div><b>Via <a href="http://www.clickatell.com/" target="_blank">Clickatell</a></b></div>
    Use <a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">Http Basic Authentication</a> with channel name and incoming password.
    
    <ul>
      <li><span style="font-family:monospace">GET <%= url_for :controller => :clickatell, :action => :index, :application_id => @application.name %></span>:
        create Application Terminated Messages</li>
    </ul>
  <% end %>
  
  </div>
<% end %>
</div>

<h4><a href="javascript:void(0)" onClick="toggle('settings')">Settings</a></h4>

<div id="settings" style="display:none">
<ul>
  <li>Max tries: <%= @application.max_tries %></li>
</ul>

<ul>
  <li><%= link_to "Edit settings / Change password", :controller => :home, :action => :edit_application %></li>
</ul>
</div>

<h4><a href="javascript:void(0)" onClick="toggle('channels')">Channels</a></h4>

<div id="channels">
<% if @channels.empty? %>
  No channels.
<% else %>
  <ul>
    <% @channels.each do |chan| %>
      <li><b><%= chan.name %></b> => protocol: <%= chan.protocol %>, kind: <%= chan.kind %>, direction: <%= chan.direction_text %> <%= link_to "edit", :controller => :home, :action => :edit_channel, :id => chan.id %> <a href="javascript:void(0)" onclick="delete_channel(<%= chan.id %>, '<%= h chan.name %>')">delete</a></li>
    <% end %>
  </ul>
<% end %>

<ul>
  <li><%= link_to "Create new Clickatell channel", :controller => :home, :action => :new_channel, :kind => 'clickatell' %></li>  
  <li><%= link_to "Create new POP3 channel", :controller => :home, :action => :new_channel, :kind => 'pop3' %></li>
  <li><%= link_to "Create new QST channel", :controller => :home, :action => :new_channel, :kind => 'qst' %></li>
  <li><%= link_to "Create new SMTP channel", :controller => :home, :action => :new_channel, :kind => 'smtp' %></li>
</ul>
</div>

<h4><a href="javascript:void(0)" onClick="toggle('last_ao_messages')">Last Application Originated Messages</a></h4>

<div id="last_ao_messages">
<form id="ao_messages_form">
<input type="hidden" name="ao_page" value="<%= @ao_page %>" />
<input type="hidden" name="ao_previous_filter" value="<%= @ao_filter %>" />
<input type="hidden" name="at_page" value="<%= @at_page %>" />
<input type="hidden" name="at_search" value="<%= @at_search %>" />
<input type="hidden" name="at_from" value="<%= @at_from %>" />
<input type="hidden" name="at_to" value="<%= @at_to %>" />
<input type="hidden" name="at_state" value="<%= @at_state %>" />
<input type="hidden" id="ao_all" name="ao_all" value="0" />

Search: <input type="text" name="ao_search" value="<%= h @ao_search %>" />
From: <input type="text" name="ao_from" value="<%= h @ao_from %>" size="13" />
To: <input type="text" name="ao_to" value="<%= h @ao_to %>" size="13" />
State: <input type="text" name="ao_state" value="<%= h @ao_state %>" size="6" />
Select: <a href="javascript:void(0)" onclick="select_all_ao_messages()">all</a>, <a href="javascript:void(0)" onclick="select_none_ao_messages()">none</a>
Actions: <a href="javascript:void(0)" onclick="mark_ao_messages_as_cancelled()">mark as cancelled</a>

<%= will_paginate @ao_messages, :param_name => 'ao_page', :params => { :ao_previous_filter => @ao_filter } %>

<div id="all_ao_messages_text" style="display:none"></div>

<input type="hidden" name="ao_page" value="<%= @ao_page %>" />
<input type="hidden" name="ao_previous_filter" value="<%= @ao_filter %>" />
<input type="hidden" name="at_page" value="<%= @at_page %>" />
<input type="hidden" name="at_search" value="<%= @at_search %>" />
<input type="hidden" name="at_from" value="<%= @at_from %>" />
<input type="hidden" name="at_to" value="<%= @at_to %>" />
<input type="hidden" name="at_state" value="<%= @at_state %>" />

<% if @ao_messages.empty? %>
  <div>No messages.</div>
<% else %>
  <table border="1">
    <tr>
      <th></th>
      <th>When</th>
      <th>Id</th>
      <th>Guid</th>
      <th>From</th>
      <th>To</th>
      <th>Subject</th>
      <th>Body</th>
      <th>Tries</th>
      <th>State</th>
    </tr>
    <tr>
    <% @ao_messages.each do |msg| %>
      <tr>
        <td><input type="checkbox" name="ao_messages[]" value="<%= msg.id %>" <% if !params[:ao_messages].nil? && params[:ao_messages].include?(msg.id.to_s); %>checked="checked"<% end; %>/></td>
        <td><%= msg.timestamp %></td>
        <td><%= msg.id %></td>
        <td><%= short_html msg.guid %></td>
        <td><%= msg.from %></td>
        <td><%= msg.to %></td>
        <td><%= short_html msg.subject %></td>
        <td><%= short_html msg.body %></td>
        <td><%= msg.tries %></td>
        <td><%= msg.state %></td>
      </tr>
    <% end %>
  </table>
<% end %>
</form>

<%= will_paginate @ao_messages, :param_name => 'ao_page', :params => { :ao_previous_filter => @ao_filter } %>
</div>

<h4><a href="javascript:void(0)" onClick="toggle('last_at_messages')">Last Application Terminated Messages</a></h4>

<div id="last_at_messages">
<form id="at_messages_form">
<input type="hidden" name="at_page" value="<%= @at_page %>" />
<input type="hidden" name="at_previous_filter" value="<%= @at_filter %>" />
<input type="hidden" name="ao_page" value="<%= @ao_page %>" />
<input type="hidden" name="ao_search" value="<%= @ao_search %>" />
<input type="hidden" name="ao_from" value="<%= @ao_from %>" />
<input type="hidden" name="ao_to" value="<%= @ao_to %>" />
<input type="hidden" name="ao_state" value="<%= @ao_state %>" />
<input type="hidden" id="at_all" name="at_all" value="0" />

Search: <input type="text" name="at_search" value="<%= h @at_search %>" />
From: <input type="text" name="at_from" value="<%= h @at_from %>" size="13"/>
To: <input type="text" name="at_to" value="<%= h @at_to %>" size="13" />
State: <input type="text" name="at_state" value="<%= h @at_state %>" size="6" />
Select: <a href="javascript:void(0)" onclick="select_all_at_messages()">all</a>, <a href="javascript:void(0)" onclick="select_none_at_messages()">none</a>
Actions: <a href="javascript:void(0)" onclick="mark_at_messages_as_cancelled()">mark as cancelled</a>

<%= will_paginate @at_messages, :param_name => 'at_page', :params => { :at_previous_filter => @at_filter } %>

<div id="all_at_messages_text" style="display:none"></div>

<% if @at_messages.empty? %>
  <div>No messages.</div>
<% else %>
  <table border="1">
    <tr>
      <th></th>
      <th>When</th>
      <th>Id</th>
      <th>Guid</th>
      <th>From</th>
      <th>To</th>
      <th>Subject</th>
      <th>Body</th>
      <th>Tries</th>
      <th>State</th>
    </tr>
    <tr>
    <% @at_messages.each do |msg| %>
      <tr>
        <td><input type="checkbox" name="at_messages[]" value="<%= msg.id %>" <% if !params[:at_messages].nil? && params[:at_messages].include?(msg.id.to_s); %>checked="checked"<% end; %>/></td>
        <td><%= msg.timestamp %></td>
        <td><%= msg.id %></td>
        <td><%= short_html msg.guid %></td>
        <td><%= msg.from %></td>
        <td><%= msg.to %></td>
        <td><%= short_html msg.subject %></td>
        <td><%= short_html msg.body %></td>
        <td><%= msg.tries %></td>
        <td><%= msg.state %></td>
      </tr>
    <% end %>
  </table>
<% end %>

<%= will_paginate @at_messages, :param_name => 'at_page', :params => { :at_previous_filter => @at_filter } %>
</form>
</div>

<h4><a href="javascript:void(0)" onClick="toggle('logs')">Logs</a></h4>

<div id="logs">
<%= will_paginate @logs, :param_name => 'logs_page' %>

<% if @logs.empty? %>
  <div>No logs.</div>
<% else %>
  <table border="1">
    <tr>
      <th>When</th>
      <th>Severity</th>
      <th>Channel</th>
      <th>AO Message</th>
      <th>AT Message</th>
      <th>Text</th>
    </tr>
    <tr>
    <% @logs.each do |log| %>
      <tr>
        <td><%= log.created_at %></td>
        <td><%= log.severity_html %></td>
        <td>
          <% if !log.channel.nil? %>
            <%= log.channel .name %>
          <% end %>
        </td>
        <td><a href="/home?ao_search=<%= log.ao_message_id %>"><%= log.ao_message_id %></a></td>
        <td><a href="/home?at_search=<%= log.at_message_id %>"><%= log.at_message_id %></a></td>
        <td><%= short_html log.message, 100 %></td>
      </tr>
    <% end %>
  </table>
<% end %>

<%= will_paginate @logs, :param_name => 'logs_page' %>
</div>

<script>
var total_ao_messages = <%= @ao_messages.total_entries %>;
var current_ao_messages = <%= @ao_messages.length %>;
var total_at_messages = <%= @at_messages.total_entries %>;
var current_at_messages = <%= @at_messages.length %>;

<%
if !params[:ao_all].nil? && params[:ao_all] == '1'
  %>
  select_all_pages_ao_messages();
  <%
end

if !params[:at_all].nil? && params[:at_all] == '1'
  %>
  select_all_pages_at_messages();
  <%
end
%>
</script>